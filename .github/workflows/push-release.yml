name: Release to environments
# This workflow is triggered when a PR is merged to main with update to 'releases/*.txt' file.  

on:
  push:
    paths:
      - releases/*

jobs:
  version:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Code checkout
        uses: actions/checkout@v4
      
      - name: Calc version
        working-directory: releases
        continue-on-error: true
        run: |
          ENVNAME=$(git log --oneline --name-only -n1 | grep 'releases' | cut -d'/' -f2 | cut -d'.' -f1)
          if [ -z "$ENVNAME" ]; then
            echo "No release file found"
            exit 0
          fi
          VERSION=$(cat "$ENVNAME.txt" | grep 'version' | cut -d'=' -f2 | tr -d ' ')
          echo ENV=$ENVNAME >> $GITHUB_ENV
          echo VERSION=$VERSION >> $GITHUB_ENV
        shell: bash

  deploy:
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Code checkout
        uses: actions/checkout@v4

      - name: Deploy to dev
        if: ${{ env.ENV == 'dev' }}
        run: echo "Deploying to dev"

      - name: Deploy to staging
        if: ${{ env.ENV == 'staging' }}
        run: echo "Deploying to staging"

      - name: Deploy to prod
        if: ${{ env.ENV == 'prod' }}
        run: echo "Deploying to prod"